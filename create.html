<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create - MINDORA.ART</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand gradient-text" href="index.html">
                <i class="fas fa-brain me-2"></i>MINDORA.ART
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gallery.html">
                            <i class="fas fa-images me-1"></i>Gallery
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="create.html">
                            <i class="fas fa-plus-circle me-1"></i>Create
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#about">
                            <i class="fas fa-info-circle me-1"></i>About
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item" id="userNavItem">
                        <div class="dropdown">
                            <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                                <i class="fas fa-user me-1"></i><span id="userDisplayName">User</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user-circle me-2"></i>Profile</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</button></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Create Header -->
    <section class="create-header">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="gradient-text mb-4">Share Your Creativity</h1>
                    <p class="lead">Publish your art, research, literature, or audio creations</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Create Form -->
    <section class="create-form py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow-lg">
                        <div class="card-body p-4">
                            <form id="createWorkForm">
                                <!-- Basic Information -->
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="workTitle" class="form-label">Title *</label>
                                            <input type="text" class="form-control" id="workTitle" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="workCategory" class="form-label">Category *</label>
                                            <select class="form-select" id="workCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="Art">🎨 Art</option>
                                                <option value="Science">🔬 Science</option>
                                                <option value="Literature">📚 Literature</option>
                                                <option value="Audio">🎵 Audio</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="workDescription" class="form-label">Description *</label>
                                    <textarea class="form-control" id="workDescription" rows="3" required 
                                        placeholder="Describe your work..."></textarea>
                                </div>

                                <!-- Content Areas (shown/hidden based on category) -->
                                <div id="textContentArea" class="content-area" style="display: none;">
                                    <div class="mb-3">
                                        <label for="workTextContent" class="form-label">Content</label>
                                        <textarea class="form-control" id="workTextContent" rows="10" 
                                            placeholder="Enter your text content here..."></textarea>
                                    </div>
                                </div>

                                <div id="fileUploadArea" class="content-area" style="display: none;">
                                    <div class="mb-3">
                                        <label for="workFile" class="form-label">Upload File</label>
                                        <input type="file" class="form-control" id="workFile" accept="">
                                        <div class="form-text" id="fileHelp">Please select a file to upload.</div>
                                    </div>
                                    <div id="filePreview" class="mt-3" style="display: none;">
                                        <!-- File preview will appear here -->
                                    </div>
                                </div>

                                <!-- Tags -->
                                <div class="mb-3">
                                    <label for="workTags" class="form-label">Tags</label>
                                    <input type="text" class="form-control" id="workTags" 
                                        placeholder="Enter tags separated by commas (e.g., abstract, digital, experimental)">
                                    <div class="form-text">Tags help others discover your work</div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" class="btn btn-secondary me-md-2" onclick="window.history.back()">
                                        <i class="fas fa-arrow-left me-1"></i>Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-upload me-1"></i>Publish Work
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-success">
                        <i class="fas fa-check-circle me-2"></i>Work Published!
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Your work has been successfully published and is now visible in the gallery.</p>
                </div>
                <div class="modal-footer">
                    <a href="gallery.html" class="btn btn-primary">View in Gallery</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Create Another</button>
                </div>
            </div>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Other scripts -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Create page functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Redirect if not authenticated
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'index.html';
                }
            });

            setupCategoryHandling();
            setupFormSubmission();
            setupFilePreview();
        });

        // Setup category-specific UI
function setupCategoryHandling() {
    const categorySelect = document.getElementById('workCategory');
    const textContentArea = document.getElementById('textContentArea');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('workFile');
    const fileHelp = document.getElementById('fileHelp');

    categorySelect.addEventListener('change', function() {
        const category = this.value;
        
        // Скрыть все области
        textContentArea.style.display = 'none';
        fileUploadArea.style.display = 'none';

        // Показать соответствующие области
        switch (category) {
            case 'Literature':
                textContentArea.style.display = 'block';
                fileUploadArea.style.display = 'block';
                fileInput.setAttribute('accept', '.pdf,.doc,.docx,.txt');
                fileHelp.textContent = 'Upload document (PDF, DOC, TXT) or enter text below';
                break;
                
            case 'Science':
                textContentArea.style.display = 'block';
                fileUploadArea.style.display = 'block';
                fileInput.setAttribute('accept', '.pdf,.doc,.docx,.txt');
                fileHelp.textContent = 'Upload document (PDF, DOC, TXT) or enter text below';
                break;
                
            case 'Art':
                fileUploadArea.style.display = 'block';
                fileInput.setAttribute('accept', 'image/*,.pdf,.doc,.docx,.txt');
                fileHelp.textContent = 'Upload image (JPG, PNG, GIF) or document (PDF, DOC, TXT)';
                break;
                
            case 'Audio':
                fileUploadArea.style.display = 'block';
                fileInput.setAttribute('accept', 'audio/*');
                fileHelp.textContent = 'Upload audio file (MP3, WAV, M4A)';
                break;
        }
    });
}

        // Setup file preview
function setupFilePreview() {
    const fileInput = document.getElementById('workFile');
    const filePreview = document.getElementById('filePreview');

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) {
            filePreview.style.display = 'none';
            return;
        }

        filePreview.style.display = 'block';
        
        if (file.type.startsWith('image/')) {
            // Превью изображений
        } 
        else if (file.type.startsWith('audio/')) {
            // Превью аудио
        }
        else if (file.type === 'application/pdf') {
            filePreview.innerHTML = `
                <h6>Preview:</h6>
                <div class="pdf-preview">
                    <i class="fas fa-file-pdf fa-5x text-danger"></i>
                    <p class="mt-2">${file.name}</p>
                    <p class="small text-muted">PDF Document (${(file.size / 1024 / 1024).toFixed(2)} MB)</p>
                </div>
            `;
        }
        else if (file.type.includes('document') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
            filePreview.innerHTML = `
                <h6>Preview:</h6>
                <div class="doc-preview">
                    <i class="fas fa-file-word fa-5x text-primary"></i>
                    <p class="mt-2">${file.name}</p>
                    <p class="small text-muted">Word Document (${(file.size / 1024 / 1024).toFixed(2)} MB)</p>
                </div>
            `;
        }
        else if (file.type === 'text/plain') {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                filePreview.innerHTML = `
                    <h6>Preview:</h6>
                    <div class="text-preview bg-light p-3" style="max-height: 200px; overflow: auto;">
                        <pre>${content.substring(0, 1000)}</pre>
                    </div>
                    <p class="small text-muted mt-2">${file.name} (${(file.size / 1024).toFixed(2)} KB)</p>
                `;
            };
            reader.readAsText(file);
        }
    });
}

        // Setup form submission
        function setupFormSubmission() {
            const form = document.getElementById('createWorkForm');
            const submitBtn = document.getElementById('submitBtn');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('You must be logged in to create works.');
                    return;
                }

                // Disable submit button and show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Publishing...';

                try {
                    const workData = await collectFormData(user);
                    await saveWorkToFirestore(workData);
                    showSuccessModal();
                    form.reset();
                    resetFormState();
                } catch (error) {
                    console.error('Error creating work:', error);
                    alert('Error publishing work: ' + error.message);
                } finally {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Publish Work';
                }
            });
        }

        // Collect form data
async function collectFormData(user) {
    const category = document.getElementById('workCategory').value;
    const title = document.getElementById('workTitle').value.trim();
    const description = document.getElementById('workDescription').value.trim();
    const tags = document.getElementById('workTags').value.trim();
    const fileInput = document.getElementById('workFile');
    const file = fileInput.files[0];

    const workData = {
        title,
        description,
        category,
        tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
        authorId: user.uid,
        authorName: user.displayName || user.email,
        createdAt: firebase.firestore.Timestamp.now()
    };

    // Обработка контента в зависимости от категории
    switch(category) {
        case 'Literature':
        case 'Science':
            const textContent = document.getElementById('workTextContent').value.trim();
            
            // Разрешаем либо текстовый контент, либо файл
            if (file) {
                // Валидация типа файла
                const validTypes = ['application/pdf', 'text/plain', 'application/msword', 
                                  'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                if (!validTypes.includes(file.type)) {
                    throw new Error('Unsupported file format. Please use PDF, DOC or TXT');
                }
                
                const fileUrl = await uploadFile(file, category, user.uid);
                workData.fileUrl = fileUrl;
                workData.fileName = file.name;
                workData.fileSize = file.size;
            }
            
            if (textContent) {
                workData.content = textContent;
            }
            
            // Проверяем что есть хотя бы что-то
            if (!textContent && !file) {
                throw new Error('Please add text content or upload a file');
            }
            break;

        case 'Art':
            if (!file) {
                throw new Error('Please select a file to upload.');
            }
            
            // Разрешаем изображения И документы
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
            const validDocTypes = ['application/pdf', 'application/msword', 
                                  'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            
            if (!validImageTypes.includes(file.type) && !validDocTypes.includes(file.type)) {
                throw new Error('Unsupported file format. Please use JPG, PNG, GIF, PDF or DOC');
            }
            
            const artFileUrl = await uploadFile(file, category, user.uid);
            workData.fileUrl = artFileUrl;
            workData.fileName = file.name;
            workData.fileSize = file.size;
            break;

        case 'Audio':
            if (!file) {
                throw new Error('Please select an audio file to upload.');
            }
            
            // Валидация аудио файлов
            const validAudioTypes = ['audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg'];
            if (!validAudioTypes.includes(file.type)) {
                throw new Error('Unsupported audio format. Please use MP3, WAV, M4A or OGG');
            }
            
            const audioFileUrl = await uploadFile(file, category, user.uid);
            workData.fileUrl = audioFileUrl;
            workData.fileName = file.name;
            workData.fileSize = file.size;
            break;
    }

    return workData;
}
// ...existing code...
function prepareWorkData(file, category, user) {
    let workData = {};
    // ...your logic...
    workData.fileSize = file.size;
    // ...other assignments...

    // Upload file to Firebase Storage
    // (You may want to move this out if you want to keep this function synchronous)
    // const fileUrl = await uploadFile(file, category, user.uid);
    // workData.fileUrl = fileUrl;
    // workData.fileName = file.name;
    // workData.fileSize = file.size;

    return workData;
}
// ...existing code...

        // Upload file to Firebase Storage
async function uploadFile(file, category, userId) {
    try {
        const storageRef = firebase.storage().ref();
        const fileName = `${category.toLowerCase()}/${userId}/${Date.now()}_${file.name}`;
        const fileRef = storageRef.child(fileName);

        // Создаем задачу загрузки
        const uploadTask = fileRef.put(file);
        
        // Ожидаем завершения загрузки
        await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                null, // Пропускаем обработчик прогресса
                (error) => reject(error), // Обработчик ошибок
                () => resolve() // Обработчик успешного завершения
            );
        });
        
        // Получаем URL для скачивания
        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
        return downloadURL;
    } catch (error) {
        console.error("File upload failed:", error);
        throw new Error("File upload failed: " + error.message);
    }
}

        // Save work to Firestore
        async function saveWorkToFirestore(workData) {
            await firebase.firestore().collection('works').add(workData);
        }

        // Show success modal
        function showSuccessModal() {
            new bootstrap.Modal(document.getElementById('successModal')).show();
        }

        // Reset form state
        function resetFormState() {
            document.getElementById('textContentArea').style.display = 'none';
            document.getElementById('fileUploadArea').style.display = 'none';
            document.getElementById('filePreview').style.display = 'none';
        }
        
    </script>
</body>
</html>
